# 传感器集成实施任务

## 实施计划

- [x] 1. 分析和诊断当前问题
  - 分析主工程中传感器无法发现的根本原因
  - 对比子工程和主工程的差异
  - 确认GPIO4电源管理问题
  - _需求: 1.1, 1.2, 1.3_

- [x] 2. 修复电源管理问题
  - [x] 2.1 修改主工程中的GPIO4电源控制逻辑
    - 移除BME280读取后的digitalWrite(PIN_BME_PWR, LOW)代码（位置：src/main.cpp:448）
    - 确保GPIO4在整个程序运行期间保持HIGH
    - 添加电源状态监控功能
    - _需求: 1.1, 1.2, 1.3, 1.4_

  - [x] 2.2 实现深度睡眠期间GPIO4状态保持
    - 在beginDeepSleep函数中添加gpio_hold_en(GPIO_NUM_4)
    - 在setup函数开始时添加gpio_hold_dis(GPIO_NUM_4)
    - 确保深度睡眠期间GPIO4保持HIGH电平
    - 验证传感器在深度睡眠期间持续供电
    - _需求: 1.1, 1.2, 1.3_

  - [x] 2.3 创建传感器电源管理模块
    - 实现SensorPowerManager类
    - 提供电源初始化和维护功能
    - 添加电源状态查询接口
    - 集成GPIO保持功能管理
    - _需求: 1.1, 1.2_

- [x] 3. 集成双传感器支持
  - [x] 3.1 添加AHT20库依赖
    - 在主工程platformio.ini中添加Adafruit AHTX0库
    - 更新BMP280库到最新版本
    - 验证库依赖兼容性
    - _需求: 2.1, 3.1_

  - [x] 3.2 创建双传感器管理模块
    - 实现DualSensorManager类
    - 集成BMP280和AHT20初始化逻辑
    - 实现I2C设备扫描功能
    - 添加传感器状态管理
    - _需求: 2.1, 2.2, 3.1, 3.2, 4.1, 4.2_

  - [x] 3.3 实现传感器数据读取
    - 创建统一的传感器数据结构
    - 实现BMP280温度和气压读取
    - 实现AHT20温度和湿度读取
    - 添加数据有效性检查
    - _需求: 2.3, 3.3_

- [x] 4. 修改主程序集成点
  - [ ] 4.1 更新main.cpp中的传感器初始化代码
    - 替换原有的BME280初始化逻辑
    - 集成新的双传感器管理器
    - 更新I2C总线配置
    - _需求: 2.1, 3.1, 4.1_

  - [x] 4.2 修改传感器数据读取逻辑
    - 更新inTemp变量赋值（使用AHT20数据）
    - 更新inHumidity变量赋值（使用AHT20数据）
    - 添加气压数据变量（使用BMP280数据）
    - 处理传感器读取失败情况
    - _需求: 2.3, 2.4, 3.3, 3.4_

- [x] 5. 更新显示系统
  - [x] 5.1 修改墨水屏显示逻辑
    - 确保气压数据正确传递给显示模块
    - 更新室内温湿度显示区域
    - 添加传感器状态指示
    - _需求: 6.1, 6.2, 6.3_

  - [x] 5.2 处理显示错误情况
    - 实现传感器数据无效时的占位符显示
    - 添加传感器错误状态显示
    - 确保显示系统不会因传感器问题崩溃
    - _需求: 2.4, 3.4, 6.4_

- [x] 6. 移除GPIO电压测试代码
  - [x] 6.1 删除GPIO测试源文件
    - 删除src/gpio_voltage_test.h文件
    - 删除src/gpio_voltage_test.cpp文件
    - 从git历史中移除这些文件
    - _需求: 5.1_

  - [x] 6.2 清理main.cpp中的GPIO测试集成
    - 移除#include "gpio_voltage_test.h"引用
    - 删除gpioTest全局变量声明
    - 移除handleSerialCommands()函数中的GPIO测试命令处理
    - 删除printCommandHelp()函数中的GPIO测试命令说明
    - 移除loop()函数中的GPIO测试相关调用
    - _需求: 5.1, 5.2_

  - [x] 6.3 清理GPIO测试相关的串口命令
    - 移除"gpio_test"命令处理逻辑
    - 移除"gpio_high"命令处理逻辑
    - 移除"gpio_low"命令处理逻辑
    - 移除"gpio_status"命令处理逻辑
    - 移除"gpio_stop"命令处理逻辑
    - 移除"bme_on"和"bme_off"命令处理逻辑
    - _需求: 5.2_

  - [x] 6.4 移除GPIO测试相关的函数声明
    - 删除handleSerialCommands()和printCommandHelp()函数声明
    - 移除startGPIOVoltageTest()和stopGPIOVoltageTest()函数声明
    - 清理未使用的函数原型
    - _需求: 5.1_

  - [x] 6.5 清理setup()函数中的GPIO测试初始化
    - 移除GPIO测试功能的启动提示信息
    - 删除GPIO测试命令的帮助文本
    - 简化setup()函数的串口输出
    - _需求: 5.2_

- [x] 7. 代码清理和优化
  - [x] 7.1 清理未使用的代码和变量
    - 移除未使用的函数声明
    - 清理调试代码和注释
    - 优化包含文件
    - 移除临时测试变量
    - _需求: 5.3_

  - [x] 7.2 代码结构优化
    - 整理include文件顺序
    - 统一代码格式和注释风格
    - 移除冗余的空行和注释
    - _需求: 5.3_
<!-- 
- [ ] 8. 错误处理和重试机制
  - [ ] 8.1 实现传感器错误处理
    - 添加传感器初始化失败处理
    - 实现I2C通信错误恢复
    - 添加传感器数据读取重试机制
    - _需求: 2.4, 3.4, 4.3_

  - [ ] 8.2 添加调试和诊断功能
    - 实现传感器状态调试输出
    - 添加I2C总线状态监控
    - 创建传感器诊断工具函数
    - _需求: 4.4_

- [ ] 9. 测试和验证
  - [ ] 9.1 GPIO4电源状态验证
    - 验证程序启动时GPIO4为HIGH (3.3V)
    - 验证BME280读取期间GPIO4保持HIGH
    - 验证进入深度睡眠前GPIO4为HIGH
    - 验证深度睡眠期间GPIO4保持HIGH (使用万用表测量)
    - 验证从深度睡眠唤醒后GPIO4仍为HIGH
    - 确认传感器无需重新初始化即可正常工作
    - _需求: 1.1, 1.2, 1.3_

  - [ ] 9.2 功能测试
    - 验证传感器能够正确发现和初始化
    - 测试BMP280气压数据读取和显示
    - 测试AHT20温湿度数据读取和显示
    - 验证I2C设备扫描功能
    - _需求: 2.1, 2.3, 3.1, 3.3_

  - [ ] 9.3 深度睡眠集成测试
    - 测试完整的数据流：传感器→处理→显示
    - 验证墨水屏显示正确性
    - 测试深度睡眠和唤醒后的传感器状态
    - 验证多次深度睡眠/唤醒循环的稳定性
    - 测量深度睡眠期间的总功耗
    - _需求: 6.1, 6.2, 6.3_

  - [ ] 9.4 稳定性测试
    - 长时间运行测试 (24小时以上)
    - 传感器断开重连测试
    - 电源波动测试
    - 多次深度睡眠/唤醒循环测试
    - 传感器数据准确性验证
    - _需求: 4.2, 4.3_ -->

- [ ] 8. 文档更新
  - [ ] 8.1 更新技术文档
    - 更新README.md中的传感器配置说明
    - 创建传感器集成指南
    - 更新硬件连接图
    - _需求: 所有需求_
<!-- 
  - [ ] 8.2 创建调试指南
    - 编写传感器故障排除指南
    - 创建常见问题解答
    - 添加调试命令说明
    - _需求: 4.4_ -->

## 关键实施要点

### 电源管理修复
```cpp
// 关键修改1：移除这行代码（位置：src/main.cpp:448）
// digitalWrite(PIN_BME_PWR, LOW);  // 删除或注释掉

// 关键修改2：深度睡眠前保持GPIO4状态
void beginDeepSleep(unsigned long startTime, tm *timeInfo) {
    // 确保传感器电源在深度睡眠期间保持开启
    digitalWrite(PIN_BME_PWR, HIGH);
    
    // 使用GPIO保持功能，确保深度睡眠期间GPIO4保持高电平
    gpio_hold_en(GPIO_NUM_4);
    
    // ... 原有的深度睡眠逻辑
    esp_deep_sleep_start();
}

// 关键修改3：唤醒后释放GPIO保持状态
void setup() {
    // 释放GPIO保持状态
    gpio_hold_dis(GPIO_NUM_4);
    
    // 确保GPIO4为高电平
    pinMode(PIN_BME_PWR, OUTPUT);
    digitalWrite(PIN_BME_PWR, HIGH);  // 保持高电平
    
    // ... 其他初始化代码
}
```

### 传感器初始化顺序
1. 设置GPIO4为HIGH（电源）
2. 初始化I2C总线
3. 扫描I2C设备
4. 初始化BMP280（地址0x77）
5. 初始化AHT20（地址0x38）
6. 验证传感器响应

### 数据流映射
```cpp
// 原有映射
inTemp = bme.readTemperature();      // BME280
inHumidity = bme.readHumidity();     // BME280

// 新映射
inTemp = aht20.getTemperature();     // AHT20温度
inHumidity = aht20.getHumidity();    // AHT20湿度
pressure = bmp280.readPressure();    // BMP280气压
```

### 错误处理策略
1. 传感器初始化失败 → 使用默认值，显示错误状态
2. I2C通信错误 → 重试3次，失败后跳过本次读取
3. 数据读取异常 → 使用上次有效值
4. 电源问题 → 重新设置GPIO4，重新初始化传感器

这个任务列表确保了系统性地解决传感器集成问题，从根本原因（电源管理）到最终目标（显示集成）的完整实施路径。