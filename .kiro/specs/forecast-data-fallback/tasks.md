# 简化实施计划 - 解决-258错误

## 🎯 核心目标
解决 `api.openweathermap.org/data/2.5/forecast` 的 **-258 错误**（反序列化输入不完整）

## 🔥 阶段1：核心功能实现（2-3天）

### 任务1：实现深度睡眠错误管理器
- [ ] 1.1 创建DeepSleepErrorManager类
  - 定义ErrorState结构体（连续错误次数、时间戳等）
  - 实现NVS持久化的错误状态存储
  - 启动时从NVS加载错误状态
  - API成功时重置错误计数
  - _直接解决: 跨深度睡眠周期的错误跟踪_

- [ ] 1.2 实现软重启逻辑
  - API失败时递增错误计数并保存到NVS
  - 连续3次-258错误触发软重启检查
  - 30分钟最小重启间隔控制
  - 执行ESP.restart()而不是进入深度睡眠
  - _直接解决: 内存状态损坏的自动恢复_

### 任务2：增强HTTP客户端
- [ ] 2.1 修改getOWMonecall函数
  - 增加HTTP超时到60秒
  - 添加响应大小检查（限制25KB）
  - API调用前检查可用内存（≥60KB）
  - 内存不足时返回特定错误码
  - _直接解决: 大响应导致的内存不足_

- [ ] 2.2 实现内存检查器
  - 创建MemoryChecker类
  - 实现checkMemoryBeforeApiCall()方法
  - 添加基本的内存清理功能
  - 检测内存碎片化程度
  - _直接解决: 预防性内存管理_

### 任务3：实现简单缓存系统
- [ ] 3.1 创建SimpleForecastCache类
  - 实现NVS存储的预报数据缓存
  - 添加基本的数据完整性检查（校验和）
  - API成功时存储数据，失败时加载缓存
  - 实现缓存年龄检查（6小时有效期）
  - _直接解决: API失败时的数据可用性_

## 🚀 阶段2：主循环集成（1天）

### 任务4：集成到主应用
- [ ] 4.1 修改主循环
  - 在setup()中初始化错误管理器
  - 在loop()中集成内存检查
  - 根据API结果决定是重启还是深度睡眠
  - 添加离线模式和内存不足模式处理
  - _确保: 与现有深度睡眠流程兼容_

- [ ] 4.2 添加显示状态
  - 缓存数据时显示"使用缓存数据"
  - 离线时显示"离线模式"
  - 内存不足时显示相应提示
  - 软重启时显示"系统重启中"
  - _确保: 用户了解当前状态_

## 🔧 阶段3：测试和优化（1天）

### 任务5：测试验证
- [ ] 5.1 功能测试
  - 模拟连续-258错误场景
  - 测试NVS状态持久化
  - 验证软重启触发和恢复
  - 测试缓存回退功能
  - _验证: 核心功能正常工作_

- [ ] 5.2 参数优化
  - 调整内存阈值（当前60KB）
  - 优化重启间隔（当前30分钟）
  - 完善错误处理逻辑
  - 添加必要的调试日志
  - _确保: 最佳性能和稳定性_

## 📋 实施策略

### 最小可行产品（MVP）
**目标**：在深度睡眠模式下解决-258错误
**时间**：4-5天
**核心文件修改**：
- `src/client_utils.cpp` - 修改getOWMonecall函数
- 新增3个简单类：DeepSleepErrorManager、MemoryChecker、SimpleForecastCache
- 主循环集成（约100行代码修改）

### 成功标准
1. ✅ -258错误发生率 < 5%
2. ✅ 连续3次错误后自动软重启
3. ✅ API失败时显示缓存数据
4. ✅ 跨深度睡眠周期状态持久化
5. ✅ 软重启成功率 > 95%

### 关键设计要点
- **错误计数持久化**：使用NVS存储，跨深度睡眠周期保持
- **软重启时机**：连续3个睡眠周期都出现-258错误
- **重启间隔**：30分钟（考虑深度睡眠周期长度）
- **内存检查**：API调用前确保≥60KB可用内存
- **缓存回退**：确保用户始终看到天气数据

### 风险控制
- 重启频率限制防止无限循环
- 缓存确保数据可用性
- 内存预检查防止崩溃
- 状态持久化确保可靠性