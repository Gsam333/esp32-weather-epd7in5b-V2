# 预报数据回退系统 - 解决-258错误

## 🎯 项目目标

**解决核心问题**：`api.openweathermap.org/data/2.5/forecast` 返回 **-258 错误**（反序列化输入不完整）

## 📋 问题分析

**根本原因**：
- 5天预报API返回大量数据（~25KB，40个数据点）
- ESP32内存不足以解析大型JSON响应
- 内存碎片化导致连续失败
- 一旦失败，内存状态损坏，需要重启才能恢复

## 🔧 解决方案

### 核心策略
1. **内存预检查**：API调用前确保≥60KB可用内存
2. **响应大小限制**：限制≤25KB，防止过大响应
3. **深度睡眠错误跟踪**：跨睡眠周期持久化错误状态
4. **软重启机制**：连续3次-258错误后自动重启
5. **缓存回退**：API失败时使用NVS缓存数据

### 关键特性
- **跨深度睡眠周期**：错误状态持久化到NVS
- **智能软重启**：30分钟间隔，自动清理内存状态
- **无缝回退**：API失败时自动使用缓存数据
- **电池友好**：不影响现有省电机制

## 📁 文档结构

### [design.md](./design.md)
- 核心问题定义和技术方案
- 深度睡眠模式工作流程
- 三个核心组件设计
- 主循环集成代码
- 配置参数和预期效果

### [tasks.md](./tasks.md)
- 简化的3阶段实施计划
- 5个核心任务，4-5天完成
- 最小可行产品(MVP)策略
- 成功标准和风险控制

### [debug-log.md](./debug-log.md)
- -258错误专项调试代码
- 深度睡眠错误跟踪
- 软重启和缓存系统调试
- 测试场景和故障排除清单

## 🚀 快速开始

### 实施优先级
1. **第1天**：实现DeepSleepErrorManager和软重启逻辑
2. **第2天**：增强HTTP客户端和内存检查
3. **第3天**：实现SimpleForecastCache缓存系统
4. **第4天**：主循环集成和测试
5. **第5天**：参数优化和验证

### 成功指标
- ✅ -258错误发生率 < 5%
- ✅ 连续3次错误后自动软重启
- ✅ API失败时显示缓存数据
- ✅ 跨深度睡眠周期状态持久化
- ✅ 软重启成功率 > 95%

## 💡 核心优势

1. **直接解决根本问题**：针对-258错误的专门方案
2. **深度睡眠兼容**：完全适配现有省电机制
3. **自动恢复能力**：无需人工干预，系统自愈
4. **用户体验连续**：始终有天气数据显示
5. **实施简单**：最小化代码修改，风险可控

这个方案将彻底解决5天预报API的-258错误问题，让ESP32天气显示系统具备真正的自愈能力！