# ESP32 电子墨水屏天气显示器 - 详细流程图

## 主程序流程图

```mermaid
flowchart TD
    A[系统启动/唤醒] --> B[初始化串口通信]
    B --> C[禁用内置LED]
    C --> D[打开非易失性存储NVS]
    D --> E{检查电池电量}
    
    E -->|电量低| F[显示低电量警告]
    F --> G[根据电量级别设置睡眠时间]
    G --> H[进入深度睡眠]
    
    E -->|电量正常| I[连接WiFi]
    I -->|连接失败| J[显示WiFi错误]
    J --> H
    
    I -->|连接成功| K[同步NTP时间]
    K -->|同步失败| L[显示时间错误]
    L --> H
    
    K -->|同步成功| M[请求OpenWeatherMap API]
    M -->|请求失败| N[显示API错误]
    N --> H
    
    M -->|请求成功| O[读取BME280/BME680传感器数据]
    O --> P[初始化电子墨水显示屏]
    P --> Q[渲染天气信息到显示屏]
    Q --> R[关闭显示屏电源]
    R --> S[计算下次唤醒时间]
    S --> H
```

## 深度睡眠计算流程图

```mermaid
flowchart TD
    A[开始计算睡眠时间] --> B[获取当前时间]
    B --> C[计算相对于WAKE_TIME的时间]
    C --> D[计算对齐到SLEEP_DURATION的时间]
    D --> E{预计唤醒时间是否在睡眠时段?}
    E -->|是| F[调整睡眠时间到下一个WAKE_TIME]
    E -->|否| G[使用标准SLEEP_DURATION]
    F --> H[添加额外延迟补偿]
    G --> H
    H --> I[设置定时器唤醒]
    I --> J[进入深度睡眠模式]
```

## 显示渲染流程图

```mermaid
flowchart TD
    A[开始渲染] --> B[初始化显示屏]
    B --> C[设置显示屏参数]
    C --> D[渲染当前天气条件]
    D --> E[渲染天气预报图表]
    E --> F[渲染5天天气预报]
    F --> G[渲染位置和日期信息]
    G --> H{有天气警报?}
    H -->|是| I[渲染天气警报信息]
    H -->|否| J[跳过警报渲染]
    I --> K[渲染状态栏]
    J --> K
    K --> L[完成页面渲染]
    L --> M[关闭显示屏电源]
```

## API数据获取流程图

```mermaid
flowchart TD
    A[开始API请求] --> B{使用HTTP还是HTTPS?}
    B -->|HTTP| C[创建HTTP客户端]
    B -->|HTTPS无证书验证| D[创建HTTPS客户端不验证证书]
    B -->|HTTPS有证书验证| E[创建HTTPS客户端并设置证书]
    
    C --> F[请求One Call API]
    D --> F
    E --> F
    
    F -->|成功| G[解析One Call JSON响应]
    F -->|失败| H[返回HTTP错误码]
    
    G --> I[请求Air Pollution API]
    I -->|成功| J[解析Air Pollution JSON响应]
    I -->|失败| K[返回HTTP错误码]
    
    J --> L[返回成功状态]
    H --> M[结束API请求]
    K --> M
    L --> M
```

## 低电量处理流程图

```mermaid
flowchart TD
    A[检测电池电压] --> B{电压 <= 低电量阈值?}
    B -->|否| C[正常操作]
    
    B -->|是| D{是首次检测到低电量?}
    D -->|是| E[在NVS中标记低电量状态]
    D -->|否| F[跳过显示更新]
    
    E --> G[显示低电量警告]
    G --> H{电压 <= 极低电量阈值?}
    F --> H
    
    H -->|是| I[进入休眠模式(需手动重置)]
    H -->|否| J{电压 <= 很低电量阈值?}
    
    J -->|是| K[设置较长睡眠间隔(120分钟)]
    J -->|否| L[设置标准低电量睡眠间隔(30分钟)]
    
    K --> M[进入深度睡眠]
    L --> M
    I --> N[结束]
    M --> N
```

## 错误处理流程图

```mermaid
flowchart TD
    A[检测错误] --> B{错误类型?}
    
    B -->|WiFi连接错误| C[显示WiFi错误图标]
    C --> D[显示"WiFi连接失败"或"SSID不可用"]
    
    B -->|API错误| E[显示API错误图标]
    E --> F[显示HTTP错误代码和描述]
    
    B -->|时间同步错误| G[显示时间错误图标]
    G --> H[显示"时间同步失败"]
    
    B -->|低电量错误| I[显示电池警告图标]
    I --> J[显示"电池电量低"]
    
    D --> K[设置下次尝试时间]
    F --> K
    H --> K
    J --> K
    
    K --> L[进入深度睡眠]
```

## 传感器数据获取流程图

```mermaid
flowchart TD
    A[开始读取传感器] --> B[设置BME电源引脚为输出]
    B --> C[打开BME电源]
    C --> D[初始化I2C通信]
    D --> E{传感器类型?}
    
    E -->|BME280| F[初始化BME280]
    E -->|BME680| G[初始化BME680]
    
    F --> H{初始化成功?}
    G --> H
    
    H -->|是| I[读取温度数据]
    H -->|否| J[记录"传感器未找到"错误]
    
    I --> K[读取湿度数据]
    K --> L{读取值是否有效?}
    
    L -->|是| M[记录成功状态]
    L -->|否| N[记录"读取失败"错误]
    
    J --> O[关闭BME电源]
    M --> O
    N --> O
    
    O --> P[结束传感器读取]
```

## 配置加载流程图

```mermaid
flowchart TD
    A[开始加载配置] --> B[从config.h读取硬件配置]
    B --> C[从config.cpp读取用户配置]
    C --> D[验证配置有效性]
    D --> E{配置是否有效?}
    
    E -->|是| F[应用配置到系统]
    E -->|否| G[使用默认配置]
    
    F --> H[结束配置加载]
    G --> H
```

## 数据流图

```mermaid
flowchart LR
    A[OpenWeatherMap API] -->|天气数据| B[ESP32]
    C[NTP服务器] -->|时间数据| B
    D[BME280/BME680] -->|温湿度数据| B
    
    B -->|显示数据| E[电子墨水屏]
    B -->|状态数据| F[非易失性存储]
    G[电池] -->|电量数据| B
    
    H[WiFi网络] <-->|网络连接| B
    I[用户配置] -->|配置参数| B
```

## 数据处理流程图

```mermaid
flowchart TD
    A[接收API JSON数据] --> B[解析JSON结构]
    B --> C[提取当前天气数据]
    C --> D[提取天气预报数据]
    D --> E[提取空气质量数据]
    E --> F[转换单位]
    F --> G[格式化显示数据]
    G --> H[返回处理后的数据]
```